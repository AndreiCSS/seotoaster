<?php $this->jQuery()->addJavascriptFile($this->websiteUrl.'system/js/external/jquery/plugins/tmpl/jquery.tmpl.min.js'); ?>
<div class="seotoaster container_12 rounded8px">
	<?php echo $this->partial('admin'.DIRECTORY_SEPARATOR.'_header.phtml', array('headerText' => 'Remove things')); ?>
	<div class="grid_12">
		<form id="removeForm" class="h500">
			<div class="grid_8">
			<?php echo $this->formSelect('folder', null, null, $this->listFolders); ?>		
			</div>
			<div class="grid_4" style="text-align: center">
				<input type="checkbox" id="check-all" />
				<label id="check-all-label" style="cursor:pointer;" for="check-all"><?php echo $this->translate('Check all?'); ?></label>
			</div>
		
			<div class="grid_12 alpha omega">
				<div id="filebrowser">
					<ul>
						<li><a href="#filebrowser-images" ><?php echo $this->translate('Images');?></a></li>
						<li><a href="#filebrowser-files" ><?php echo $this->translate('Files');?></a></li>
					</ul>
					<div id="filebrowser-images" class="filebrowser-zone">
						
					</div>
					<div id="filebrowser-files" class="filebrowser-zone">
						
					</div>
				</div>
			</div>
		</form>
	</div>
	<div class="grid_12 ui-widget-header ui-corner-all">
		<button id="deleteBtn" style="float:right; margin: 5px 10px;" ><?php echo $this->translate('Delete');?></button>
	</div>
</div>

<script id="imageContainerTemplate" type="text/x-jquery-tmpl">
    <div class="file-container grid_3">
		<img src="${src}" alt="${name}"/>
		<input type="checkbox" class="toremove" name="removeImages[]" value="${name}" />
	</div>
</script>
<script id="fileContainerTemplate" type="text/x-jquery-tmpl">
    <div class="file-container">
		<label>${name}</label>
		<input type="checkbox" class="toremove toremove-file" name="removeFiles[]" value="${name}" />
	</div>
</script>

<script type="text/javascript">
<?php //$this->jQuery()->onLoadCaptureStart();?>
	$('#deleteBtn').button();
	$('#check-all').button();
	
	$('#filebrowser').tabs({
		select: function(event, ui) { 
			var total = $(ui.panel).find('input.toremove').size();
			var checked = $(ui.panel).find('input.toremove:checked').size();
			if (total > 0 && total === checked) {
				$('#check-all').attr('checked', 'checked');
			} else {
				$('#check-all').removeAttr('checked');
			}
			$('#check-all').button('refresh');
		}
	});
	
	// disabling clicking on non-folder item
	$('#folder>option:first').attr('disabled', true);
	
	$('#folder').change(function(){
		$('.filebrowser-zone').html('');
		$('.counter').text('');
		
		if ($(this).val() == 0){
			return false;
		}
		
		$('#check-all:checked').removeAttr('checked');
			
		$.ajax({
			url: '<?php echo $this->url(array('action'=>'getdirectorycontent'));?>',
			type: 'post',
			data: {folder: $(this).val()},
			dataType: 'json',
			success: function(response){		
				$('#imageContainerTemplate').tmpl(response.imageList).appendTo('#filebrowser-images');
				$('#fileContainerTemplate').tmpl(response.filesList).appendTo('#filebrowser-files');
				console.log(response);
			}
		});
	});
	
	/**
	 * Handler for delete
	 */
	$('#deleteBtn').bind('click', function(event){
		event.preventDefault();
		$.ajax({
			url: '<?php echo $this->url(array('action'=>'removefile'));?>',
			type: 'post',
			data: $('#removeForm').serialize(),
			dataType: 'html',
			beforeSend: function(xhr){
				
			},
			success: function(response){		
				$('#filebrowser').html(response);
			}
		});
		console.log($('#filebrowser').serialize());
	});
	
	$('.file-container').live('toggleActive', function(){
		var $flag = $(this).children('input.toremove');
		if ($flag.attr('checked')){
			$flag.removeAttr('checked');
			$(this).removeClass('active');
			if ($(this).closest('.filebrowser-zone').find('.active').size() > 0) {
				$('#check-all').removeAttr('checked');
			}
		} else {
			$(this).addClass('active');
			$flag.attr('checked', 'checked');
			if ($(this).closest('.filebrowser-zone').find('.file-container:not(.active)').size() === 0){
				$('#check-all:not(:checked)').attr('checked', 'checked');
			}
		}
		$('#check-all').button('refresh');
	}).live('click', function(){
		$(this).trigger('toggleActive');
	}).delegate('input:checkbox', 'click', function(event){
		//
	});
	
	/**
	 * handling "check all" checkbox
	 */
	$('#check-all').change(function(){
		var selectedIndex = $( "#filebrowser" ).tabs( "option", "selected" );
		if ($(this).attr('checked')) {
			var items = $('.filebrowser-zone:eq('+selectedIndex+')').find('.file-container:not(.active)')
		} else {
			var items = $('.filebrowser-zone:eq('+selectedIndex+')').find('.file-container.active');
		}
		if (items.size()){
			items.trigger('toggleActive');
		}
	});
	$('#check-all-label').bind('click', function(){
		$('#check-all').trigger('change');
	});
<?php //$this->jQuery()->onLoadCaptureEnd();?>
</script>

<style type="text/css">
	#filebrowser .filebrowser-zone {
/*		outline: 1px dashed red;*/
		overflow-y: auto;
		max-height: 500px;
		max-height: 500px;
		padding: 5px;
	}
	#filebrowser div.file-container {
		text-align: center;
		margin-top: 5px;
		position: relative;
		max-height: 96px;
		opacity: 1;
		cursor: pointer;
	}
	#filebrowser div.file-container.active {
		opacity: 0.3;
		outline: 1px solid red;
	}
	#filebrowser div.file-container:hover {
		opacity: 0.3;
		-webkit-transition: opacity 0.5s ease;
		-moz-transition: opacity 0.5s ease;
		-o-transition: opacity 0.5s ease;
		-ms-transition: opacity 0.5s ease;
		transition: opacity 0.5s ease;
	}
	#filebrowser div.file-container img {
		width: 100%;
		height: 96px
	}
	#filebrowser div.file-container input.toremove { 
		position: absolute;
		right: 0;
		bottom: 0;
		padding: 2px;
		margin: 4px;
		background-color: yellow;
	}
	
	#filebrowser div.file-container p::before {
		content: '';
		background: left 50% no-repeat;
		width: 16px;
	    height: 16px;
	}
	#filebrowser div.file-container label.pdf::before {
		background-image:  url('/system/images/fileicons.png');
	}
</style>